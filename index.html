import React, { useState } from 'react';
import { User, ChevronUp, ChevronDown } from 'lucide-react';

export default function LineReceivePreview() {
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState('');
  const [richMenuType, setRichMenuType] = useState('none'); // 'none', 'small', 'large'
  const [showPhone, setShowPhone] = useState(false);
  const [showMenu, setShowMenu] = useState(false);

  const handleAddMessage = () => {
    if (inputText.trim()) {
      const now = new Date();
      const time = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
      setMessages([...messages, {
        id: Date.now(),
        text: inputText,
        time: time
      }]);
      setInputText('');
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleAddMessage();
    }
  };

  const handleClear = () => {
    setMessages([]);
  };

  const toggleMenu = () => {
    setShowMenu(!showMenu);
  };

  // 15-16文字で改行を入れる関数（空白行保持版）
  const formatText = (text) => {
    if (!text) return '';
    
    const result = [];
    const lines = text.split('\n');
    
    for (let line of lines) {
      if (line === '') {
        // 空行はそのまま保持
        result.push('');
        continue;
      }
      
      let currentLine = '';
      let charCount = 0;
      
      for (let char of line) {
        currentLine += char;
        charCount++;
        
        if (charCount >= 15) {
          result.push(currentLine);
          currentLine = '';
          charCount = 0;
        }
      }
      
      if (currentLine) {
        result.push(currentLine);
      }
    }
    
    return result.join('\n');
  };

  // リッチメニューの高さを計算
  const getRichMenuHeight = () => {
    if (!showMenu) return 0;
    if (richMenuType === 'large') return 270; // 大サイズ (810/3)
    if (richMenuType === 'small') return 135; // 小サイズ (405/3)
    return 0;
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-white p-8">
      <div className="flex gap-8 max-w-7xl w-full">
        {/* 入力エリア */}
        <div className="flex-1 bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-8 border border-gray-100">
          <h2 className="text-xl font-bold mb-6 text-gray-900 tracking-tight">メッセージを入力</h2>
          <div className="relative">
            <textarea
              value={inputText}
              onChange={(e) => setInputText(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder="メッセージを入力してください..."
              className="w-full h-64 p-6 border-2 border-gray-200 rounded-2xl resize-none focus:outline-none focus:border-blue-400 focus:ring-4 focus:ring-blue-50 text-lg transition-all shadow-sm bg-white"
              style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}
            />
          </div>
          <button
            onClick={handleAddMessage}
            className="mt-6 w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-2xl transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 text-base"
          >
            メッセージ追加
          </button>
          
          <div className="mt-6 pt-6 border-t border-gray-200 space-y-2.5">
            <button
              onClick={handleClear}
              className="w-full px-4 py-2.5 bg-gradient-to-r from-red-50 to-rose-50 hover:from-red-100 hover:to-rose-100 text-red-600 rounded-xl font-medium transition-all shadow-sm hover:shadow-md border border-red-100 text-sm"
            >
              メッセージクリア
            </button>
            
            <div className="space-y-2">
              <p className="text-xs font-bold text-gray-600 tracking-wide uppercase mt-3">リッチメニュー</p>
              <button
                onClick={() => setRichMenuType('small')}
                className={`w-full px-4 py-2.5 rounded-xl font-medium transition-all shadow-sm hover:shadow-md text-sm ${
                  richMenuType === 'small' 
                    ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg' 
                    : 'bg-white hover:bg-gray-50 text-gray-700 border border-gray-200'
                }`}
              >
                リッチメニュー(小)表示
              </button>
              <button
                onClick={() => setRichMenuType('large')}
                className={`w-full px-4 py-2.5 rounded-xl font-medium transition-all shadow-sm hover:shadow-md text-sm ${
                  richMenuType === 'large' 
                    ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg' 
                    : 'bg-white hover:bg-gray-50 text-gray-700 border border-gray-200'
                }`}
              >
                リッチメニュー(大)表示
              </button>
            </div>

            <button
              onClick={() => setShowPhone(!showPhone)}
              className="w-full px-4 py-2.5 bg-gradient-to-r from-slate-700 to-slate-800 hover:from-slate-800 hover:to-slate-900 text-white rounded-xl font-medium transition-all shadow-lg md:hidden text-sm"
            >
              {showPhone ? 'プレビューを隠す' : 'プレビューを表示'}
            </button>
          </div>
        </div>

        {/* スマホプレビュー */}
        <div className={`flex-shrink-0 ${showPhone ? 'block' : 'hidden'} md:block`}>
          <div className="bg-gray-900 rounded-3xl p-3 shadow-2xl" style={{ width: '360px' }}>
            {/* スマホのノッチ部分 */}
            <div className="bg-black rounded-t-3xl pt-2 pb-1">
              <div className="flex justify-center">
                <div className="w-32 h-6 bg-black rounded-b-2xl"></div>
              </div>
            </div>
            
            {/* スマホ画面 (9:19.5比率 - iPhone風) */}
            <div className="bg-white rounded-2xl overflow-hidden shadow-2xl relative" style={{ height: '702px' }}>
              {/* LINEヘッダー */}
              <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center gap-3 backdrop-blur-sm bg-opacity-95">
                <div className="w-10 h-10 bg-gradient-to-br from-gray-200 to-gray-300 rounded-full flex items-center justify-center shadow-sm">
                  <User size={24} className="text-gray-600" />
                </div>
                <div className="flex-1">
                  <div className="font-bold text-gray-900">公式アカウント</div>
                </div>
              </div>

              {/* メッセージエリア */}
              <div 
                className="overflow-y-auto p-4" 
                style={{ 
                  backgroundColor: '#95B1DA',
                  height: `calc(702px - 60px - 50px - ${getRichMenuHeight()}px)`
                }}
              >
                {messages.map((msg) => (
                  <div key={msg.id} className="flex mb-3 justify-start">
                    <div className="max-w-[75%]">
                      <div className="bg-white text-black rounded-xl px-4 py-3 shadow-md">
                        <div className="text-[15px] leading-relaxed break-words whitespace-pre-wrap" style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}>
                          {formatText(msg.text)}
                        </div>
                      </div>
                      <div className="text-xs text-gray-700 mt-1 px-1 font-medium">
                        {msg.time}
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {/* リッチメニュー */}
              {showMenu && richMenuType !== 'none' && (
                <div 
                  className="bg-gradient-to-b from-white to-gray-50 border-t-2 border-gray-200 relative shadow-inner"
                  style={{ height: `${getRichMenuHeight()}px` }}
                >
                  <button 
                    onClick={toggleMenu}
                    className="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-9 h-9 bg-white rounded-full shadow-lg flex items-center justify-center border-2 border-gray-200 hover:border-gray-300 transition-all"
                  >
                    <ChevronDown size={20} className="text-gray-600" />
                  </button>
                  <div className="flex items-center justify-center h-full text-gray-400 text-sm font-semibold">
                    リッチメニュー({richMenuType === 'small' ? '小' : '大'})
                  </div>
                </div>
              )}

              {/* メニューボタン - 最下部に固定 */}
              <div 
                className="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex items-center justify-center py-3"
                style={{ height: '50px' }}
              >
                <button 
                  onClick={toggleMenu}
                  className="flex items-center gap-1 text-gray-600 text-sm font-medium hover:bg-gray-50 px-4 py-2 rounded-lg transition-colors"
                >
                  <span>メニュー</span>
                  {showMenu ? <ChevronDown size={16} /> : <ChevronUp size={16} />}
                </button>
              </div>
              
              {/* リッチメニューなしの場合、下部に丸みを追加 */}
              {richMenuType === 'none' && (
                <div className="rounded-b-[2.5rem] h-0"></div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
